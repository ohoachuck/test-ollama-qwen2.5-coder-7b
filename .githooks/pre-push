#!/bin/bash

# Hook pre-push pour une vÃ©rification finale avant le push
# Ce script effectue une vÃ©rification supplÃ©mentaire avant de pousser vers le remote

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸ” VÃ©rification finale avant push...${NC}"

# RÃ©cupÃ©rer la branche actuelle
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Patterns sensibles Ã  rechercher dans l'historique rÃ©cent
SENSITIVE_PATTERNS=(
    "api[_-]?key"
    "api[_-]?secret"
    "password"
    "passwd"
    "AKIA[0-9A-Z]{16}"
    "ghp_[a-zA-Z0-9]{36}"
    "-----BEGIN.*PRIVATE KEY-----"
    "xox[baprs]-"
    "AIza[0-9A-Za-z\-_]{35}"
    "sk_live_"
    "https?://[^:]+:[^@]+@"
)

# Lire les informations du push
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Suppression de branche, pas de vÃ©rification nÃ©cessaire
        continue
    fi
    
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # Nouvelle branche, vÃ©rifier tous les commits
        range="$local_sha"
    else
        # Branche existante, vÃ©rifier les nouveaux commits
        range="$remote_sha..$local_sha"
    fi
    
    # VÃ©rifier les commits qui vont Ãªtre poussÃ©s
    COMMITS=$(git rev-list "$range")
    
    if [ -z "$COMMITS" ]; then
        continue
    fi
    
    FOUND_ISSUES=0
    
    echo -e "${YELLOW}VÃ©rification de $(echo "$COMMITS" | wc -l | tr -d ' ') commit(s)...${NC}"
    
    # VÃ©rifier chaque commit
    for commit in $COMMITS; do
        # Obtenir les fichiers modifiÃ©s dans ce commit
        FILES=$(git diff-tree --no-commit-id --name-only -r "$commit")
        
        for FILE in $FILES; do
            # Ignorer les fichiers binaires et certains types
            if echo "$FILE" | grep -qE "\.(png|jpg|jpeg|gif|svg|ico|pdf|lock|pbxproj)$|\.xcassets/"; then
                continue
            fi
            
            # VÃ©rifier si le fichier existe dans ce commit
            if ! git cat-file -e "$commit:$FILE" 2>/dev/null; then
                continue
            fi
            
            # Obtenir le contenu du fichier Ã  ce commit
            CONTENT=$(git show "$commit:$FILE" 2>/dev/null)
            
            if [ -z "$CONTENT" ]; then
                continue
            fi
            
            # VÃ©rifier chaque pattern
            for PATTERN in "${SENSITIVE_PATTERNS[@]}"; do
                if echo "$CONTENT" | grep -qiE "$PATTERN"; then
                    if [ $FOUND_ISSUES -eq 0 ]; then
                        echo -e "\n${RED}âš ï¸  ATTENTION: Informations potentiellement sensibles dÃ©tectÃ©es!${NC}\n"
                    fi
                    
                    echo -e "${RED}Commit: $(git log -1 --format='%h - %s' $commit)${NC}"
                    echo -e "${YELLOW}Fichier: $FILE${NC}"
                    echo -e "${YELLOW}Pattern: $PATTERN${NC}"
                    echo ""
                    
                    FOUND_ISSUES=$((FOUND_ISSUES + 1))
                fi
            done
        done
    done
    
    # Si des problÃ¨mes ont Ã©tÃ© trouvÃ©s
    if [ $FOUND_ISSUES -gt 0 ]; then
        echo -e "\n${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ PUSH BLOQUÃ‰: $FOUND_ISSUES problÃ¨me(s) potentiel(s) dÃ©tectÃ©(s)${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "\n${YELLOW}Actions recommandÃ©es:${NC}"
        echo -e "  1. VÃ©rifiez les fichiers et commits mentionnÃ©s ci-dessus"
        echo -e "  2. Si nÃ©cessaire, utilisez 'git rebase -i' pour modifier l'historique"
        echo -e "  3. Ou crÃ©ez un nouveau commit pour retirer les informations sensibles"
        echo -e "\n${YELLOW}Pour forcer le push (NON RECOMMANDÃ‰):${NC}"
        echo -e "  git push --no-verify"
        echo ""
        exit 1
    fi
done

echo -e "${GREEN}âœ“ VÃ©rification terminÃ©e - Aucun problÃ¨me dÃ©tectÃ©${NC}\n"
exit 0
