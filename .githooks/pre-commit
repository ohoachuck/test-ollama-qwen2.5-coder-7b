#!/bin/bash

# Hook pre-commit pour dÃ©tecter les informations sensibles
# Ce script vÃ©rifie les fichiers staged pour dÃ©tecter des donnÃ©es sensibles

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸ” VÃ©rification des informations sensibles...${NC}"

# Patterns Ã  dÃ©tecter (regex)
PATTERNS=(
    # ClÃ©s API et tokens
    "api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    "api[_-]?secret['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    "access[_-]?token['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    "auth[_-]?token['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    "bearer['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    
    # Mots de passe
    "password['\"]?\s*[:=]\s*['\"][^'\"]{3,}['\"]"
    "passwd['\"]?\s*[:=]\s*['\"][^'\"]{3,}['\"]"
    "pwd['\"]?\s*[:=]\s*['\"][^'\"]{3,}['\"]"
    
    # ClÃ©s privÃ©es
    "-----BEGIN (RSA |DSA |EC )?PRIVATE KEY-----"
    "-----BEGIN OPENSSH PRIVATE KEY-----"
    
    # AWS
    "AKIA[0-9A-Z]{16}"
    "aws[_-]?access[_-]?key[_-]?id"
    "aws[_-]?secret[_-]?access[_-]?key"
    
    # Tokens GitHub
    "ghp_[a-zA-Z0-9]{36}"
    "gho_[a-zA-Z0-9]{36}"
    "ghu_[a-zA-Z0-9]{36}"
    "ghs_[a-zA-Z0-9]{36}"
    "ghr_[a-zA-Z0-9]{36}"
    
    # Tokens GitLab
    "glpat-[a-zA-Z0-9_\-]{20,}"
    
    # Slack tokens
    "xox[baprs]-[0-9a-zA-Z\-]+"
    
    # Google API
    "AIza[0-9A-Za-z\-_]{35}"
    
    # Stripe
    "sk_live_[0-9a-zA-Z]{24,}"
    "pk_live_[0-9a-zA-Z]{24,}"
    
    # Tokens gÃ©nÃ©riques
    "token['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    "secret['\"]?\s*[:=]\s*['\"][a-zA-Z0-9_\-]{20,}['\"]"
    
    # URLs avec credentials
    "https?://[a-zA-Z0-9]+:[a-zA-Z0-9]+@"
    
    # Adresses email sensibles (optionnel)
    # "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
)

# Fichiers Ã  ignorer
IGNORE_PATTERNS=(
    "\.lock$"
    "package-lock\.json$"
    "yarn\.lock$"
    "\.min\.js$"
    "\.min\.css$"
    "\.map$"
    "\.png$"
    "\.jpg$"
    "\.jpeg$"
    "\.gif$"
    "\.svg$"
    "\.ico$"
    "\.pdf$"
    "\.xcassets/"
    "\.pbxproj$"
)

# Fonction pour vÃ©rifier si un fichier doit Ãªtre ignorÃ©
should_ignore() {
    local file=$1
    for pattern in "${IGNORE_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            return 0
        fi
    done
    return 1
}

# RÃ©cupÃ©rer les fichiers staged
FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$FILES" ]; then
    echo -e "${GREEN}âœ“ Aucun fichier Ã  vÃ©rifier${NC}"
    exit 0
fi

FOUND_ISSUES=0
CHECKED_FILES=0

# VÃ©rifier chaque fichier
for FILE in $FILES; do
    # Ignorer les fichiers binaires et certains types
    if should_ignore "$FILE"; then
        continue
    fi
    
    # VÃ©rifier si le fichier existe (peut avoir Ã©tÃ© supprimÃ©)
    if [ ! -f "$FILE" ]; then
        continue
    fi
    
    CHECKED_FILES=$((CHECKED_FILES + 1))
    
    # VÃ©rifier chaque pattern
    for PATTERN in "${PATTERNS[@]}"; do
        # Recherche insensible Ã  la casse
        MATCHES=$(git diff --cached "$FILE" | grep -iE "$PATTERN" | grep "^\+" | grep -v "^\+\+\+")
        
        if [ ! -z "$MATCHES" ]; then
            if [ $FOUND_ISSUES -eq 0 ]; then
                echo -e "\n${RED}âš ï¸  ATTENTION: Informations sensibles dÃ©tectÃ©es!${NC}\n"
            fi
            
            echo -e "${RED}Fichier: $FILE${NC}"
            echo -e "${YELLOW}Pattern dÃ©tectÃ©: $PATTERN${NC}"
            echo -e "Lignes concernÃ©es:"
            echo "$MATCHES" | sed 's/^/  /'
            echo ""
            
            FOUND_ISSUES=$((FOUND_ISSUES + 1))
        fi
    done
done

echo -e "${GREEN}âœ“ $CHECKED_FILES fichier(s) vÃ©rifiÃ©(s)${NC}"

# Si des problÃ¨mes ont Ã©tÃ© trouvÃ©s
if [ $FOUND_ISSUES -gt 0 ]; then
    echo -e "\n${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ COMMIT BLOQUÃ‰: $FOUND_ISSUES problÃ¨me(s) dÃ©tectÃ©(s)${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "\n${YELLOW}Actions recommandÃ©es:${NC}"
    echo -e "  1. Retirez les informations sensibles des fichiers"
    echo -e "  2. Utilisez des variables d'environnement"
    echo -e "  3. Ajoutez les fichiers sensibles Ã  .gitignore"
    echo -e "  4. Utilisez un fichier .env (et ajoutez-le Ã  .gitignore)"
    echo -e "\n${YELLOW}Pour forcer le commit (NON RECOMMANDÃ‰):${NC}"
    echo -e "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ“ Aucune information sensible dÃ©tectÃ©e${NC}\n"
exit 0
